<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Add VIDA to MetaMask</title>
  <style>
    :root{
      --bg:#0b1c14; --card:#10261c; --text:#d9f7e8; --muted:#bfead6; --warn:#ffd38a; --ok:#9ff0c9; --accent:#39c18f;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center;
    }
    .wrap{width:min(720px,92%); text-align:center}
    .card{
      background:var(--card); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.25);
      padding:28px 24px;
    }
    h1{margin:0 0 10px; font-size:32px; line-height:1.15}
    p{margin:8px 0; color:var(--muted)}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    code{background:#0e1f17; border:1px solid #214734; border-radius:6px; padding:2px 6px}
    #addrBox{
      display:none; margin-top:12px; text-align:left;
      padding:12px 14px; border:1px solid #214734; border-radius:10px; background:#0e1f17;
    }
    #addrRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    #copyBtn{
      cursor:pointer; border:1px solid #214734; background:#132a20; color:#d9f7e8;
      padding:6px 10px; border-radius:8px; font-weight:700;
    }
    .manual{
      display:none; margin-top:16px; text-align:left;
      padding:16px 18px; border:1px solid #254837; border-radius:12px; background:#0e1f17;
    }
    ol{margin:6px 0 0 18px; line-height:1.6}
    .small{font-size:.92rem}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Setting up <span style="color:#7DE3B1">VIDA</span> for you…</h1>
      <p id="status">Step 1/5 — Connecting to your wallet</p>

      <!-- Address box (shown after we connect) -->
      <div id="addrBox">
        <div class="small" style="margin-bottom:6px;">Your wallet address (copied to clipboard):</div>
        <div id="addrRow">
          <code id="addr">0x…</code>
          <button id="copyBtn" aria-label="Copy address">Copy again</button>
          <span id="copyNote" class="ok" style="display:none;">Copied!</span>
        </div>
      </div>

      <!-- Manual fallback (shown only if auto-add fails) -->
      <div id="manual" class="manual">
        <p class="warn" style="margin-top:0;"><b>Manual add (MetaMask mobile):</b></p>
        <ol>
          <li>Open MetaMask → Assets → <i>Import tokens</i>.</li>
          <li>Network: <b>Base</b> (chainId 8453).</li>
          <li>Paste contract: <code>0x1D929E2422AEC567907f7fE2B966f7f84CA1858F</code>.</li>
          <li>Symbol: <b>VIDA</b>, Decimals: <b>18</b>.</li>
        </ol>
      </div>

      <p class="small" style="margin-top:14px;">
        Tip (mobile): open this page <b>inside the MetaMask app’s Browser</b>.
        If you’re viewing in Mail/Safari, long-press the link → “Open in MetaMask”.
      </p>
      <p class="small">Contract: <code>0x1D929E2422AEC567907f7fE2B966f7f84CA1858F</code> · Network: <code>Base (8453)</code></p>
    </section>
  </main>

  <script>
  // ---- Config ----
  const TOKEN = {
    address: '0x1D929E2422AEC567907f7fE2B966f7f84CA1858F',
    symbol:  'VIDA',
    decimals: 18,
    // PNG is often more reliable for logos inside wallets; keep SVG if you prefer.
    image:   'https://rawcdn.githack.com/taclarke2020-droid/Vida-Coin-Demo/refs/heads/main/vida-32.png'
  };
  const BASE = {
    chainId: '0x2105', // 8453
    chainName: 'Base',
    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
    rpcUrls: ['https://mainnet.base.org'],
    blockExplorerUrls: ['https://basescan.org']
  };

  // ---- Helpers ----
  const $ = id => document.getElementById(id);
  const setStatus = (text, cls) => {
    const el = $('status');
    if (!el) return;
    el.textContent = text;
    el.className = cls || '';
  };
  const showManual = () => { const m = $('manual'); if (m) m.style.display = 'block'; };
  const showAddr = (addr) => {
    $('addr').textContent = addr;
    $('addrBox').style.display = 'block';
  };
  async function copyToClipboard(text){
    try {
      // Clipboard API (works in most modern contexts incl. MetaMask browser)
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      // Fallback: try a hidden textarea selection
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        return true;
      } catch { return false; }
    }
  }

  // Switch to (or add) Base
  async function ensureBase(eth){
    try {
      await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.chainId }] });
    } catch (e) {
      if (e && e.code === 4902) {
        await eth.request({ method:'wallet_addEthereumChain', params:[BASE] });
        await eth.request({ method:'wallet_switchEthereumChain', params:[{ chainId: BASE.chainId }] });
      } else {
        throw e;
      }
    }
  }

  async function runSetup(){
    const eth = window.ethereum;

    if (!eth || !eth.isMetaMask) {
      setStatus('Please open this page inside the MetaMask app (Browser tab) or use desktop with the MetaMask extension.', 'warn');
      showManual();
      return;
    }

    // 1) Connect
    setStatus('Step 1/5 — Connecting to your wallet');
    let accounts = [];
    try {
      accounts = await eth.request({ method:'eth_requestAccounts' });
    } catch (e) {
      setStatus('We couldn’t connect to MetaMask. Please approve the connection and reload.', 'warn');
      showManual();
      return;
    }
    const addr = (accounts && accounts[0]) ? accounts[0] : null;
    if (!addr) {
      setStatus('No account returned from MetaMask. Please unlock/approve and reload.', 'warn');
      showManual();
      return;
    }

    // 2) Copy address
    setStatus('Step 2/5 — Copying your address');
    showAddr(addr);
    const copied = await copyToClipboard(addr);
    if (copied) {
      const note = $('copyNote');
      if (note) { note.style.display = 'inline'; setTimeout(()=> note.style.display='none', 1600); }
    }

    // 3) Switch to Base
    setStatus('Step 3/5 — Switching to Base');
    try {
      await ensureBase(eth);
    } catch (e) {
      setStatus('Could not switch to Base automatically. You can add VIDA manually below.', 'warn');
      showManual();
      return;
    }

    // Give mobile a beat to settle after network change
    await new Promise(r => setTimeout(r, 300));

    // 4) Add VIDA with logo
    setStatus('Step 4/5 — Adding VIDA to your wallet');
    try {
      const ok = await eth.request({
        method:'wallet_watchAsset',
        params:{ type:'ERC20', options: TOKEN }
      });
      if (!ok) {
        setStatus('MetaMask declined to add VIDA. You can add it manually below.', 'warn');
        showManual();
        return;
      }
    } catch (e) {
      // One retry helps on some mobile builds
      await new Promise(r => setTimeout(r, 600));
      try {
        const ok2 = await eth.request({
          method:'wallet_watchAsset',
          params:{ type:'ERC20', options: TOKEN }
        });
        if (!ok2) {
          setStatus('MetaMask declined to add VIDA. You can add it manually below.', 'warn');
          showManual();
          return;
        }
      } catch (e2) {
        setStatus('Could not add VIDA automatically. Please use the manual steps below.', 'warn');
        showManual();
        return;
      }
    }

    // 5) Done
    setStatus('✅ Step 5/5 — All set! VIDA was added and your address was copied.', 'ok');

    // Allow user to re-copy if needed
    $('copyBtn').addEventListener('click', async ()=>{
      const ok = await copyToClipboard(addr);
      const note = $('copyNote');
      if (note) {
        note.textContent = ok ? 'Copied!' : 'Copy failed';
        note.className = ok ? 'ok' : 'warn';
        note.style.display = 'inline';
        setTimeout(()=> note.style.display='none', 1600);
      }
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    // Auto-run shortly after load
    setTimeout(runSetup, 250);
  });
  </script>
</body>
</html>
